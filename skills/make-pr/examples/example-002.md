> this is example
---
## ğŸ“Œ Summary
API ì„œë¹„ìŠ¤(`commerce-api`)ì™€ ë…ë¦½ëœ ì§‘ê³„ ì„œë¹„ìŠ¤(`commerce-streamer`)ë¥¼ ì¶”ê°€í•˜ê³ , ë‘ ì„œë¹„ìŠ¤ ê°„ ëŠìŠ¨í•œ ì—°ê²°ì„ Kafka ê¸°ë°˜ ì´ë²¤íŠ¸ íŒŒì´í”„ë¼ì¸ìœ¼ë¡œ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

**ì£¼ìš” êµ¬í˜„ ë‚´ìš©:**
- **Producer (commerce-api)**: Transactional Outbox Patternì„ í†µí•œ ì´ë²¤íŠ¸ ë°œí–‰ (ë„ë©”ì¸ íŠ¸ëœì­ì…˜ê³¼ ë™ì¼ íŠ¸ëœì­ì…˜ì—ì„œ Outbox ì €ì¥, ë³„ë„ ìŠ¤ì¼€ì¤„ëŸ¬ê°€ Kafkaë¡œ ë°œí–‰)
- **Consumer (commerce-streamer)**: ì´ë²¤íŠ¸ ìˆ˜ì·¨ ë° ìƒí’ˆ ë©”íŠ¸ë¦­ ì§‘ê³„ (ì¢‹ì•„ìš” ìˆ˜, íŒë§¤ëŸ‰, ì¡°íšŒ ìˆ˜)
- **ë©±ë“±ì„± ë³´ì¥**: `event_handled` í…Œì´ë¸”(UUID ê¸°ë°˜ eventId)ê³¼ `version` í•„ë“œ(aggregateIdë³„ ìˆœì°¨ì  ë²„ì „)ë¥¼ í†µí•œ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€
- **ìˆœì„œ ë³´ì¥**: íŒŒí‹°ì…˜ í‚¤ ê¸°ë°˜ ì´ë²¤íŠ¸ ìˆœì„œ ë³´ì¥ ë° `offset.reset: latest` ì„¤ì •ìœ¼ë¡œ ë¶ˆí•„ìš”í•œ ê³¼ê±° ë©”ì‹œì§€ ì²˜ë¦¬ ë°©ì§€

**êµ¬í˜„ëœ ì´ë²¤íŠ¸:**
- `like-events`: `LikeAdded`, `LikeRemoved` â†’ ì¢‹ì•„ìš” ìˆ˜ ì§‘ê³„
- `order-events`: `OrderCreated` â†’ íŒë§¤ëŸ‰ ì§‘ê³„
- `product-events`: `ProductViewed` â†’ ì¡°íšŒ ìˆ˜ ì§‘ê³„

## ğŸ’¬ Review Points

#### 1. Transactional Outbox Pattern êµ¬í˜„ ë°©ì‹ì˜ ì ì ˆì„±

**ë°°ê²½ ë° ë¬¸ì œ ìƒí™©:**
ì™¸ë¶€ ì‹œìŠ¤í…œ(Kafka)ê³¼ì˜ í†µì‹ ì´ í•„ìš”í•œ ìƒí™©ì—ì„œ, ë„ë©”ì¸ íŠ¸ëœì­ì…˜ê³¼ Kafka ë°œí–‰ì„ ë™ì¼ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì„ ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ì´ë²¤íŠ¸ ìœ ì‹¤ ê°€ëŠ¥ì„±ì´ ìˆì—ˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì£¼ë¬¸ ìƒì„± íŠ¸ëœì­ì…˜ì´ ì„±ê³µí–ˆì§€ë§Œ Kafka ë°œí–‰ì´ ì‹¤íŒ¨í•˜ë©´, ì§‘ê³„ ì„œë¹„ìŠ¤ëŠ” í•´ë‹¹ ì£¼ë¬¸ ì´ë²¤íŠ¸ë¥¼ ë°›ì§€ ëª»í•˜ê²Œ ë©ë‹ˆë‹¤. ë°˜ëŒ€ë¡œ Kafka ë°œí–‰ì€ ì„±ê³µí–ˆì§€ë§Œ ë„ë©”ì¸ íŠ¸ëœì­ì…˜ì´ ë¡¤ë°±ë˜ë©´, ì‹¤ì œë¡œëŠ” ì£¼ë¬¸ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ëŠ”ë° ì§‘ê³„ ì„œë¹„ìŠ¤ëŠ” ì£¼ë¬¸ ì´ë²¤íŠ¸ë¥¼ ë°›ê²Œ ë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.

**í•´ê²° ë°©ì•ˆ:**
ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ Transactional Outbox Patternì„ ì ìš©í–ˆìŠµë‹ˆë‹¤. ë„ë©”ì¸ íŠ¸ëœì­ì…˜ê³¼ ê°™ì€ íŠ¸ëœì­ì…˜ì—ì„œ `OutboxEvent`ë¥¼ DBì— ë¨¼ì € ì €ì¥í•˜ê³ , ë³„ë„ ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì£¼ê¸°ì ìœ¼ë¡œ PENDING ìƒíƒœì˜ ì´ë²¤íŠ¸ë¥¼ ì½ì–´ Kafkaë¡œ ë°œí–‰í•˜ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ë„ë©”ì¸ íŠ¸ëœì­ì…˜ì´ ì„±ê³µí•˜ë©´ Outboxì— ì´ë²¤íŠ¸ê°€ ì €ì¥ë˜ê³ , íŠ¸ëœì­ì…˜ì´ ë¡¤ë°±ë˜ë©´ Outbox ì €ì¥ë„ í•¨ê»˜ ë¡¤ë°±ë˜ì–´ ì¼ê´€ì„±ì´ ë³´ì¥ë©ë‹ˆë‹¤.

**êµ¬í˜„ ì„¸ë¶€ì‚¬í•­:**
1. **ApplicationEvent â†’ OutboxEvent ë³€í™˜**: `OutboxBridgeEventListener`ê°€ `@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)`ë¡œ ì„¤ì •ë˜ì–´, ë„ë©”ì¸ íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ëœ í›„ì—ë§Œ Outboxì— ì €ì¥í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ë„ë©”ì¸ ë¡œì§ì´ ì‹¤íŒ¨í•˜ì—¬ íŠ¸ëœì­ì…˜ì´ ë¡¤ë°±ë˜ë©´ Outbox ì €ì¥ë„ ë¡¤ë°±ë˜ì–´ ë¶ˆí•„ìš”í•œ ì´ë²¤íŠ¸ê°€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

2. **ìŠ¤ì¼€ì¤„ëŸ¬ ê¸°ë°˜ ë°œí–‰**: `OutboxEventPublisher`ê°€ 1ì´ˆë§ˆë‹¤ ì‹¤í–‰ë˜ì–´ PENDING ìƒíƒœì˜ ì´ë²¤íŠ¸ë¥¼ ìµœëŒ€ 100ê°œì”© ì½ì–´ Kafkaë¡œ ë°œí–‰í•©ë‹ˆë‹¤. ë°œí–‰ ì„±ê³µ ì‹œ `PUBLISHED` ìƒíƒœë¡œ ë³€ê²½í•˜ê³ , ì‹¤íŒ¨ ì‹œ `FAILED` ìƒíƒœë¡œ ë³€ê²½í•˜ì—¬ ë‹¤ìŒ ìŠ¤ì¼€ì¤„ì—ì„œ ì¬ì‹œë„í•  ìˆ˜ ìˆë„ë¡ í–ˆìŠµë‹ˆë‹¤.

**ê´€ë ¨ ì½”ë“œ:**
```java
// OutboxBridgeEventListener.java - ë„ë©”ì¸ íŠ¸ëœì­ì…˜ ì»¤ë°‹ í›„ì—ë§Œ Outboxì— ì €ì¥
@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
public void handleLikeAdded(LikeEvent.LikeAdded event) {
    outboxEventService.saveEvent(/* ... */);
}

// OutboxEventPublisher.java - 1ì´ˆë§ˆë‹¤ PENDING ì´ë²¤íŠ¸ë¥¼ ì½ì–´ Kafkaë¡œ ë°œí–‰
@Scheduled(fixedDelay = 1000)
public void publishPendingEvents() {
    List<OutboxEvent> pendingEvents = outboxEventRepository.findPendingEvents(BATCH_SIZE);
    for (OutboxEvent event : pendingEvents) {
        publishEvent(event);
        event.markAsPublished();  // PUBLISHED ìƒíƒœë¡œ ë³€ê²½
    }
}
```

**ê³ ë¯¼í•œ ì :**
- `@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)`ë¥¼ ì‚¬ìš©í•œ ì´ìœ ëŠ”, ë„ë©”ì¸ íŠ¸ëœì­ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì»¤ë°‹ëœ í›„ì—ë§Œ Outboxì— ì €ì¥í•˜ì—¬ ì¼ê´€ì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤. ë§Œì•½ `AFTER_COMMIT`ì´ ì•„ë‹Œ ë‹¤ë¥¸ ì‹œì ì— ì €ì¥í•˜ë©´, ë„ë©”ì¸ ë¡œì§ì´ ì‹¤íŒ¨í•˜ì—¬ ë¡¤ë°±ë˜ì—ˆëŠ”ë°ë„ Outboxì— ì´ë²¤íŠ¸ê°€ ì €ì¥ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ `AFTER_COMMIT`ì€ íŠ¸ëœì­ì…˜ì´ ì™„ì „íˆ ì»¤ë°‹ëœ í›„ì— ì‹¤í–‰ë˜ë¯€ë¡œ, Outbox ì €ì¥ ì‹¤íŒ¨ ì‹œ ë„ë©”ì¸ íŠ¸ëœì­ì…˜ì„ ë¡¤ë°±í•  ìˆ˜ ì—†ë‹¤ëŠ” ë‹¨ì ì´ ìˆìŠµë‹ˆë‹¤. ì´ ë¶€ë¶„ì— ëŒ€í•œ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.

- ìŠ¤ì¼€ì¤„ëŸ¬ ì£¼ê¸°(1ì´ˆ)ì™€ ë°°ì¹˜ í¬ê¸°(100)ëŠ” í˜„ì¬ íŠ¸ë˜í”½ì„ ê³ ë ¤í•˜ì—¬ ì„¤ì •í–ˆì§€ë§Œ, ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì´ë²¤íŠ¸ ë°œìƒ ë¹ˆë„ì™€ Kafka ì²˜ë¦¬ ì†ë„ë¥¼ ê³ ë ¤í•˜ì—¬ ì¡°ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë„ˆë¬´ ì§§ì€ ì£¼ê¸°(ì˜ˆ: 100ms)ëŠ” DB ë¶€í•˜ë¥¼ ì¦ê°€ì‹œí‚¬ ìˆ˜ ìˆê³ , ë„ˆë¬´ ê¸´ ì£¼ê¸°(ì˜ˆ: 10ì´ˆ)ëŠ” ì´ë²¤íŠ¸ ë°œí–‰ ì§€ì—°ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- ê°œë³„ ì´ë²¤íŠ¸ ë°œí–‰ ì‹¤íŒ¨ ì‹œ `FAILED` ìƒíƒœë¡œ ë³€ê²½í•˜ê³  ê³„ì† ì§„í–‰í•˜ë„ë¡ í–ˆëŠ”ë°, ì´ë ‡ê²Œ í•˜ë©´ ì¼ë¶€ ì´ë²¤íŠ¸ë§Œ ì‹¤íŒ¨í•´ë„ ë‹¤ìŒ ìŠ¤ì¼€ì¤„ì—ì„œ ì¬ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ `FAILED` ìƒíƒœì˜ ì´ë²¤íŠ¸ë¥¼ ë³„ë„ë¡œ ëª¨ë‹ˆí„°ë§í•˜ê±°ë‚˜, ì¬ì‹œë„ íšŸìˆ˜ ì œí•œì„ ë‘ëŠ” ë“±ì˜ ì¶”ê°€ ë¡œì§ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

#### 2. ë©±ë“±ì„± ì²˜ë¦¬ ì „ëµ: event_handled í…Œì´ë¸”ê³¼ version í•„ë“œì˜ ì¡°í•©

**ë°°ê²½ ë° ë¬¸ì œ ìƒí™©:**
KafkaëŠ” ê¸°ë³¸ì ìœ¼ë¡œ At Least Once ë³´ì¥ì„ ì œê³µí•˜ë¯€ë¡œ, ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë‚˜ Consumer ì¬ì‹œì‘ ë“±ì˜ ìƒí™©ì—ì„œ ë™ì¼í•œ ë©”ì‹œì§€ê°€ ì—¬ëŸ¬ ë²ˆ ì „ë‹¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ Producer ì¸¡ì—ì„œë„ `acks=all`, `enable.idempotence=true` ì„¤ì •ìœ¼ë¡œ At Least Onceë¥¼ ë³´ì¥í•˜ë¯€ë¡œ, ë™ì¼í•œ ì´ë²¤íŠ¸ê°€ ì¤‘ë³µ ë°œí–‰ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ì¤‘ë³µ ë©”ì‹œì§€ë¥¼ ê·¸ëŒ€ë¡œ ì²˜ë¦¬í•˜ë©´ ì¢‹ì•„ìš” ìˆ˜ë‚˜ íŒë§¤ëŸ‰ì´ ì¤‘ë³µ ì§‘ê³„ë˜ì–´ ì˜ëª»ëœ ë©”íŠ¸ë¦­ì´ ìƒì„±ë©ë‹ˆë‹¤.

**í•´ê²° ë°©ì•ˆ:**
ì¤‘ë³µ ì²˜ë¦¬ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ë‘ ê°€ì§€ ì „ëµì„ ì¡°í•©í–ˆìŠµë‹ˆë‹¤:
1. **event_handled í…Œì´ë¸”**: ë™ì¼ `eventId`ì˜ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€ (ë™ì¼ ì´ë²¤íŠ¸ì˜ ì™„ì „ ì¤‘ë³µ ë°©ì§€)
2. **version í•„ë“œ**: ì˜¤ë˜ëœ ì´ë²¤íŠ¸ê°€ ìµœì‹  ìƒíƒœë¥¼ ë®ì–´ì“°ëŠ” ê²ƒ ë°©ì§€ (ìˆœì„œê°€ ë’¤ë°”ë€ ì´ë²¤íŠ¸ ì²˜ë¦¬ ë°©ì§€)

**êµ¬í˜„ ì„¸ë¶€ì‚¬í•­:**

**1) event_handled í…Œì´ë¸”ì„ í†µí•œ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€:**
- ê° ì´ë²¤íŠ¸ì— UUID ê¸°ë°˜ì˜ ê³ ìœ í•œ `eventId`ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.
- Consumerì—ì„œ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ê¸° ì „ì— `event_handled` í…Œì´ë¸”ì—ì„œ í•´ë‹¹ `eventId`ê°€ ì´ë¯¸ ì²˜ë¦¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
- ì´ë¯¸ ì²˜ë¦¬ëœ ê²½ìš° ìŠ¤í‚µí•˜ê³ , ì²˜ë¦¬ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì‹¤í–‰í•œ í›„ `event_handled` í…Œì´ë¸”ì— ê¸°ë¡ì„ ì €ì¥í•©ë‹ˆë‹¤.
- `event_handled` í…Œì´ë¸”ì˜ `event_id` ì»¬ëŸ¼ì— UNIQUE ì œì•½ì¡°ê±´ì„ ì„¤ì •í•˜ì—¬, ë™ì‹œì„± ìƒí™©ì—ì„œë„ ì¤‘ë³µ ì²˜ë¦¬ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤. ë§Œì•½ ë‘ ê°œì˜ Consumer ì¸ìŠ¤í„´ìŠ¤ê°€ ë™ì‹œì— ê°™ì€ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ë ¤ê³  í•˜ë©´, í•˜ë‚˜ëŠ” ì„±ê³µí•˜ê³  ë‹¤ë¥¸ í•˜ë‚˜ëŠ” UNIQUE ì œì•½ì¡°ê±´ ìœ„ë°˜ ì˜ˆì™¸ê°€ ë°œìƒí•˜ì—¬ ì¤‘ë³µ ì²˜ë¦¬ê°€ ë°©ì§€ë©ë‹ˆë‹¤.

**2) version í•„ë“œë¥¼ í†µí•œ ì˜¤ë˜ëœ ì´ë²¤íŠ¸ ì²˜ë¦¬ ë°©ì§€:**
- `OutboxEvent`ì— `aggregateId`ë³„ë¡œ ìˆœì°¨ì ìœ¼ë¡œ ì¦ê°€í•˜ëŠ” `version` í•„ë“œë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, `productId=1`ì— ëŒ€í•œ ì²« ë²ˆì§¸ ì´ë²¤íŠ¸ëŠ” `version=1`, ë‘ ë²ˆì§¸ ì´ë²¤íŠ¸ëŠ” `version=2`ê°€ ë©ë‹ˆë‹¤.
- ì´ `version`ì€ Kafka ë©”ì‹œì§€ í—¤ë”ì— í¬í•¨ë˜ì–´ Consumerë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.
- Consumerì—ì„œ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•  ë•Œ, `ProductMetrics`ì˜ í˜„ì¬ `version`ê³¼ ì´ë²¤íŠ¸ì˜ `version`ì„ ë¹„êµí•©ë‹ˆë‹¤. ì´ë²¤íŠ¸ì˜ `version`ì´ ë©”íŠ¸ë¦­ì˜ `version`ë³´ë‹¤ í¬ë©´ ì—…ë°ì´íŠ¸í•˜ê³ , ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ìŠ¤í‚µí•©ë‹ˆë‹¤.
- ì´ë ‡ê²Œ í•˜ë©´ ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì´ë‚˜ íŒŒí‹°ì…˜ ìˆœì„œ ë¬¸ì œë¡œ ì¸í•´ ì˜¤ë˜ëœ ì´ë²¤íŠ¸ê°€ ë‚˜ì¤‘ì— ë„ì°©í•˜ë”ë¼ë„, ì´ë¯¸ ë” ìµœì‹  ë²„ì „ì˜ ë©”íŠ¸ë¦­ì´ ì¡´ì¬í•˜ë©´ ì˜¤ë˜ëœ ì´ë²¤íŠ¸ëŠ” ë¬´ì‹œë©ë‹ˆë‹¤.

**ê´€ë ¨ ì½”ë“œ:**
```java
// OutboxEventService.java - eventId(UUID)ì™€ version(aggregateIdë³„ ìˆœì°¨ ì¦ê°€) ë¶€ì—¬
public void saveEvent(...) {
    String eventId = UUID.randomUUID().toString();
    Long nextVersion = outboxEventRepository.findLatestVersionByAggregateId(...) + 1L;
    // OutboxEventì— eventIdì™€ version ì €ì¥
}

// OutboxEventPublisher.java - Kafka í—¤ë”ì— eventIdì™€ version í¬í•¨
private void publishEvent(OutboxEvent event) {
    messageBuilder
        .setHeader("eventId", event.getEventId())
        .setHeader("version", event.getVersion());
}

// ProductMetricsConsumer.java - ë©±ë“±ì„± ì²´í¬ ë° ë²„ì „ ë¹„êµ
public void consumeLikeEvents(...) {
    String eventId = extractEventId(record);
    if (eventHandledService.isAlreadyHandled(eventId)) continue;  // ì¤‘ë³µ ì²´í¬

    Long eventVersion = extractVersion(record);
    productMetricsService.incrementLikeCount(productId, eventVersion);  // version ë¹„êµ í¬í•¨
    eventHandledService.markAsHandled(eventId, ...);
}

// ProductMetricsService.java - version ë¹„êµë¡œ ìµœì‹  ì´ë²¤íŠ¸ë§Œ ë°˜ì˜
public void incrementLikeCount(Long productId, Long eventVersion) {
    if (!metrics.shouldUpdate(eventVersion)) return;  // ì˜¤ë˜ëœ ì´ë²¤íŠ¸ ìŠ¤í‚µ
    metrics.incrementLikeCount();
}
```

**ê³ ë¯¼í•œ ì :**
- `event_handled` í…Œì´ë¸”ì˜ UNIQUE ì œì•½ì¡°ê±´ìœ¼ë¡œ ë™ì‹œì„± ìƒí™©ì—ì„œë„ ì¤‘ë³µ ì²˜ë¦¬ë¥¼ ë°©ì§€í–ˆì§€ë§Œ, ì´ í…Œì´ë¸”ì´ ê³„ì† ì¦ê°€í•˜ëŠ” ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì‹œê°„ì´ ì§€ë‚˜ë©´ì„œ ì´ í…Œì´ë¸”ì˜ ë°ì´í„°ê°€ ë¬´í•œì • ì¦ê°€í•˜ê²Œ ë˜ëŠ”ë°, ì´ëŠ” ìŠ¤í† ë¦¬ì§€ ë¹„ìš©ê³¼ ì¡°íšŒ ì„±ëŠ¥ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. TTL(Time To Live)ì„ ì„¤ì •í•˜ì—¬ ì¼ì • ê¸°ê°„ì´ ì§€ë‚œ ë ˆì½”ë“œë¥¼ ìë™ìœ¼ë¡œ ì‚­ì œí•˜ê±°ë‚˜, ì•„ì¹´ì´ë¹™ ì „ëµì„ ìˆ˜ë¦½í•˜ì—¬ ì˜¤ë˜ëœ ë°ì´í„°ë¥¼ ë³„ë„ í…Œì´ë¸”ë¡œ ì´ë™ì‹œí‚¤ëŠ” ë“±ì˜ ë°©ì•ˆì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- `version` í•„ë“œëŠ” `aggregateId`ë³„ë¡œ ìë™ ì¦ê°€í•˜ë„ë¡ êµ¬í˜„í–ˆëŠ”ë°, ì´ ë°©ì‹ì˜ ì¥ì ì€ ê°„ë‹¨í•˜ê³  ìˆœì°¨ì ì¸ ë²„ì „ ê´€ë¦¬ê°€ ê°€ëŠ¥í•˜ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. í•˜ì§€ë§Œ `updatedAt` ê¸°ë°˜ ë°©ì‹ê³¼ ë¹„êµí–ˆì„ ë•Œ, `updatedAt`ì€ ì‹œê°„ ê¸°ë°˜ì´ë¯€ë¡œ ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì´ë‚˜ ì‹œìŠ¤í…œ ì‹œê°„ ë¶ˆì¼ì¹˜ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°˜ë©´ `version`ì€ ìˆœì°¨ì ìœ¼ë¡œ ì¦ê°€í•˜ë¯€ë¡œ ì´ëŸ¬í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë§Œ, `aggregateId`ë³„ë¡œ ë³„ë„ì˜ ë²„ì „ì„ ê´€ë¦¬í•´ì•¼ í•˜ë¯€ë¡œ ë³µì¡ë„ê°€ ì¦ê°€í•©ë‹ˆë‹¤. ì´ ë°©ì‹ì´ ì ì ˆí•œì§€, ë˜ëŠ” ë‹¤ë¥¸ ë°©ì‹(ì˜ˆ: `updatedAt` ê¸°ë°˜, ë˜ëŠ” ì´ë²¤íŠ¸ ë°œìƒ ì‹œì ì˜ íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜)ì´ ë” ë‚˜ì€ì§€ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.

- `event_handled` í…Œì´ë¸”ê³¼ `version` í•„ë“œë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¤‘ë³µì¼ ìˆ˜ ìˆë‹¤ëŠ” ì˜ë¬¸ë„ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ë‘ ê°€ì§€ëŠ” ì„œë¡œ ë‹¤ë¥¸ ëª©ì ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. `event_handled`ëŠ” ë™ì¼í•œ ì´ë²¤íŠ¸ì˜ ì™„ì „ ì¤‘ë³µì„ ë°©ì§€í•˜ê³ , `version`ì€ ìˆœì„œê°€ ë’¤ë°”ë€ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë¡œ ì¸í•´ `version=3` ì´ë²¤íŠ¸ê°€ ë¨¼ì € ë„ì°©í•˜ê³  `version=2` ì´ë²¤íŠ¸ê°€ ë‚˜ì¤‘ì— ë„ì°©í•˜ëŠ” ê²½ìš°, `event_handled`ë¡œëŠ” ì¤‘ë³µì„ ê°ì§€í•  ìˆ˜ ì—†ì§€ë§Œ `version`ìœ¼ë¡œëŠ” ì˜¤ë˜ëœ ì´ë²¤íŠ¸ì„ì„ ê°ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

#### 3. íŒŒí‹°ì…˜ í‚¤ ê¸°ë°˜ ìˆœì„œ ë³´ì¥ê³¼ offset.reset: latest ì„¤ì •ì˜ ì¡°í•©

**ë°°ê²½ ë° ë¬¸ì œ ìƒí™©:**
KafkaëŠ” ê¸°ë³¸ì ìœ¼ë¡œ íŒŒí‹°ì…˜ ë‚´ì—ì„œë§Œ ìˆœì„œë¥¼ ë³´ì¥í•˜ê³ , ì„œë¡œ ë‹¤ë¥¸ íŒŒí‹°ì…˜ ê°„ì˜ ìˆœì„œëŠ” ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë˜í•œ Consumerê°€ ì¬ì‹œì‘ë˜ê±°ë‚˜ ìƒˆë¡œìš´ Consumer Groupì´ ì‹œì‘ë  ë•Œ, ê³¼ê±°ì˜ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ë‹¤ì‹œ ì²˜ë¦¬í•˜ê²Œ ë˜ë©´ ì´ë¯¸ ì²˜ë¦¬ëœ ì˜¤ë˜ëœ ë©”ì‹œì§€ë¥¼ ì¤‘ë³µ ì²˜ë¦¬í•˜ê±°ë‚˜, í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ì´ì „ í…ŒìŠ¤íŠ¸ì˜ ë©”ì‹œì§€ê°€ ë‹¤ìŒ í…ŒìŠ¤íŠ¸ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**í•´ê²° ë°©ì•ˆ:**

**1) íŒŒí‹°ì…˜ í‚¤ ê¸°ë°˜ ìˆœì„œ ë³´ì¥:**
- ê°™ì€ ë„ë©”ì¸ì—ì„œ ë°œìƒí•œ ì´ë²¤íŠ¸ëŠ” ë™ì¼í•œ íŒŒí‹°ì…˜ì—ì„œ ì²˜ë¦¬ë˜ë„ë¡ íŒŒí‹°ì…˜ í‚¤ë¥¼ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.
- `like-events`ì™€ `product-events`ëŠ” `productId`ë¥¼ íŒŒí‹°ì…˜ í‚¤ë¡œ ì‚¬ìš©í•˜ì—¬, ê°™ì€ ìƒí’ˆì— ëŒ€í•œ ì´ë²¤íŠ¸ëŠ” í•­ìƒ ê°™ì€ íŒŒí‹°ì…˜ì—ì„œ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
- `order-events`ëŠ” `orderId`ë¥¼ íŒŒí‹°ì…˜ í‚¤ë¡œ ì‚¬ìš©í•˜ì—¬, ê°™ì€ ì£¼ë¬¸ì— ëŒ€í•œ ì´ë²¤íŠ¸ëŠ” í•­ìƒ ê°™ì€ íŒŒí‹°ì…˜ì—ì„œ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
- ì´ë ‡ê²Œ í•˜ë©´ ê°™ì€ aggregate rootì— ëŒ€í•œ ì´ë²¤íŠ¸ëŠ” ìˆœì„œê°€ ë³´ì¥ë˜ì–´, ì˜ˆë¥¼ ë“¤ì–´ `LikeAdded` â†’ `LikeRemoved` ìˆœì„œë¡œ ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ Consumerë„ ê°™ì€ ìˆœì„œë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**2) offset.reset: latest ì„¤ì •:**
- Consumerê°€ ìƒˆë¡œìš´ Consumer Groupìœ¼ë¡œ ì‹œì‘í•  ë•Œ(offsetì´ ì—†ì„ ë•Œ), ìµœì‹  ë©”ì‹œì§€ë¶€í„° ì½ê¸° ì‹œì‘í•˜ë„ë¡ `offset.reset: latest`ë¥¼ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.
- ì´ë ‡ê²Œ í•˜ë©´ Consumerê°€ ì¬ì‹œì‘ë˜ê±°ë‚˜ ìƒˆë¡œìš´ Consumer Groupì´ ì‹œì‘ë  ë•Œ, ê³¼ê±°ì˜ ì˜¤ë˜ëœ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ì§€ ì•Šê³  ìµœì‹  ë©”ì‹œì§€ë¶€í„° ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- íŠ¹íˆ í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” ì´ì „ í…ŒìŠ¤íŠ¸ì—ì„œ ë°œí–‰í•œ ë©”ì‹œì§€ê°€ ë‹¤ìŒ í…ŒìŠ¤íŠ¸ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šë„ë¡ í•˜ëŠ” ë° ìœ ìš©í•©ë‹ˆë‹¤.

**ë‹¤ë¥¸ ì˜µì…˜ê³¼ì˜ ë¹„êµ:**
- `offset.reset: latest` ì„¤ì •ì€ ìƒˆë¡œìš´ Consumer Groupì´ ì‹œì‘í•  ë•Œ ìµœì‹  ë©”ì‹œì§€ë¶€í„° ì½ê¸° ì‹œì‘í•˜ë¯€ë¡œ, `earliest`ë¥¼ ì‚¬ìš©í•  ê²½ìš° ë°œìƒí•˜ëŠ” ë¬¸ì œ(ì´ì „ í…ŒìŠ¤íŠ¸ì˜ ë©”ì‹œì§€ê°€ ë‹¤ìŒ í…ŒìŠ¤íŠ¸ì— ì˜í–¥ì„ ì£¼ì–´ í…ŒìŠ¤íŠ¸ ê²©ë¦¬ ì‹¤íŒ¨)ë¥¼ ë°©ì§€í•˜ê³ , `manual` ë°©ì‹ì²˜ëŸ¼ ë³µì¡í•œ offset ê´€ë¦¬ ë¡œì§ ì—†ì´ë„ í…ŒìŠ¤íŠ¸ ê²©ë¦¬ë¥¼ ë³´ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ê·¸ëŸ¬ë‚˜ `latest` ì„¤ì •ì€ ìƒˆë¡œìš´ Consumer Groupì´ ì‹œì‘í•  ë•Œë§Œ ì ìš©ë˜ë¯€ë¡œ, ê°™ì€ Consumer Groupì„ ê³„ì† ì‚¬ìš©í•˜ëŠ” ê²½ìš° ì´ë¯¸ ì»¤ë°‹ëœ offsetì´ ìˆìœ¼ë©´ `latest`ëŠ” ì ìš©ë˜ì§€ ì•Šê³  ê¸°ì¡´ offsetë¶€í„° ê³„ì† ì½ê²Œ ë©ë‹ˆë‹¤.
- ë”°ë¼ì„œ í†µí•© í…ŒìŠ¤íŠ¸ì—ì„œëŠ” `KafkaCleanUp.resetAllTestTopics()`ë¡œ í† í”½ì„ ì‚­ì œí•˜ê³  ì¬ìƒì„±í•˜ì—¬ Consumer Groupì„ ì´ˆê¸°í™”í•¨ìœ¼ë¡œì¨, ë§¤ í…ŒìŠ¤íŠ¸ë§ˆë‹¤ `offset.reset: latest` ì„¤ì •ì´ ì ìš©ë˜ë„ë¡ í•˜ê³ , ì´ì „ í…ŒìŠ¤íŠ¸ì˜ ë©”ì‹œì§€ê°€ ì™„ì „íˆ ì œê±°ë˜ì–´ í…ŒìŠ¤íŠ¸ ê°„ ê²©ë¦¬ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.

**êµ¬í˜„ ì„¸ë¶€ì‚¬í•­:**

**íŒŒí‹°ì…˜ í‚¤ ì„¤ì •:**
```java
// OutboxBridgeEventListener.java
// productIdë¥¼ íŒŒí‹°ì…˜ í‚¤ë¡œ ì‚¬ìš©
public void handleLikeAdded(LikeEvent.LikeAdded event) {
    outboxEventService.saveEvent(
        "LikeAdded",
        event.productId().toString(),  // aggregateId
        "Product",
        event,
        "like-events",
        event.productId().toString()  // partitionKey
    );
}

// OutboxEventPublisher.java
// Kafka ë©”ì‹œì§€ì— íŒŒí‹°ì…˜ í‚¤ ì„¤ì •
private void publishEvent(OutboxEvent event) {
    Object payload = objectMapper.readValue(event.getPayload(), Object.class);

    var messageBuilder = MessageBuilder
        .withPayload(payload)
        .setHeader(KafkaHeaders.KEY, event.getPartitionKey())  // íŒŒí‹°ì…˜ í‚¤ ì„¤ì •
        .setHeader("eventId", event.getEventId())
        .setHeader("version", event.getVersion());

    kafkaTemplate.send(event.getTopic(), message);
}
```

**offset.reset: latest ì„¤ì •:**
```yaml
# modules/kafka/src/main/resources/kafka.yml
spring:
  kafka:
    properties:
      auto.offset.reset: latest  # ìƒˆë¡œìš´ Consumer Group ì‹œì‘ ì‹œ ìµœì‹  ë©”ì‹œì§€ë¶€í„°
    producer:
      properties:
        acks: all                    # ëª¨ë“  ë¦¬í”Œë¦¬ì¹´ì— ì“°ê¸° í™•ì¸
        enable.idempotence: true     # ì¤‘ë³µ ë°©ì§€
    consumer:
      properties:
        enable-auto-commit: false    # ìˆ˜ë™ ì»¤ë°‹ ì‚¬ìš©
    listener:
      ack-mode: manual               # ìˆ˜ë™ ì»¤ë°‹ ëª¨ë“œ
```

**í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œì˜ í† í”½ ë° Consumer Group ì´ˆê¸°í™”:**
```java
// KafkaCleanUp.java
// í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì „ì— í† í”½ê³¼ Consumer Groupì„ ì´ˆê¸°í™”í•˜ì—¬ offset.reset: latestê°€ ì ìš©ë˜ë„ë¡ í•¨
public void resetAllTestTopics() {
    deleteAllTestTopics();
    recreateTestTopics();
}

public void resetAllConsumerGroups() {
    try (AdminClient adminClient = createAdminClient()) {
        Set<String> consumerGroups = adminClient.listConsumerGroups()
            .all()
            .get(5, TimeUnit.SECONDS)
            .stream()
            .map(group -> group.groupId())
            .collect(java.util.stream.Collectors.toSet());

        if (!consumerGroups.isEmpty()) {
            DeleteConsumerGroupsResult deleteResult = adminClient.deleteConsumerGroups(consumerGroups);
            deleteResult.all().get(5, TimeUnit.SECONDS);
        }
    } catch (Exception e) {
        // Consumer Groupì´ ì—†ê±°ë‚˜ ì´ë¯¸ ì‚­ì œëœ ê²½ìš° ë¬´ì‹œ
    }
}
```

**í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œì˜ ê²©ë¦¬ ë³´ì¥:**
- `offset.reset: latest`ëŠ” ìƒˆë¡œìš´ Consumer Groupì´ ì‹œì‘í•  ë•Œë§Œ ì ìš©ë˜ë¯€ë¡œ, ì´ë¯¸ offsetì´ ì»¤ë°‹ëœ Consumer Groupì—ì„œëŠ” ì ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë”°ë¼ì„œ í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” ê° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì „ì— `KafkaCleanUp.resetAllTestTopics()`ì™€ `resetAllConsumerGroups()`ë¥¼ í˜¸ì¶œí•˜ì—¬ í† í”½ê³¼ Consumer Groupì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.
- ì´ë ‡ê²Œ í•˜ë©´ ë§¤ í…ŒìŠ¤íŠ¸ë§ˆë‹¤ `offset.reset: latest` ì„¤ì •ì´ ì ìš©ë˜ì–´, ì´ì „ í…ŒìŠ¤íŠ¸ì˜ ë©”ì‹œì§€ê°€ ë‹¤ìŒ í…ŒìŠ¤íŠ¸ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.
- ë˜í•œ í…ŒìŠ¤íŠ¸ í”„ë¡œíŒŒì¼ì—ì„œ Consumer Group IDë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±(`${spring.application.name}-test-${random.uuid}`)í•˜ì—¬, ê° í…ŒìŠ¤íŠ¸ë§ˆë‹¤ ë‹¤ë¥¸ Consumer Groupì„ ì‚¬ìš©í•˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ì´ì „ í…ŒìŠ¤íŠ¸ì˜ offsetì´ ë‹¤ìŒ í…ŒìŠ¤íŠ¸ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.

**ê´€ë ¨ ì½”ë“œ:**
```java
// KafkaCleanUp.java - í…ŒìŠ¤íŠ¸ ê²©ë¦¬ë¥¼ ìœ„í•œ ì´ˆê¸°í™”
public void resetAllTestTopics() {
    deleteAllTestTopics();  // ëª¨ë“  ë©”ì‹œì§€ ì œê±°
    recreateTestTopics();   // ê¹¨ë—í•œ ìƒíƒœë¡œ ì¬ìƒì„±
}

// ProductMetricsConsumerIntegrationTest.java
@BeforeEach
void setUp() {
    kafkaCleanUp.resetAllTestTopics();      // í† í”½ ì´ˆê¸°í™”
    kafkaCleanUp.resetAllConsumerGroups();  // Consumer Group ì´ˆê¸°í™”
}
```

**ê³ ë¯¼í•œ ì :**
- `offset.reset: latest`ëŠ” ìƒˆë¡œìš´ Consumer Groupì´ ì‹œì‘í•  ë•Œë§Œ ì ìš©ë˜ë¯€ë¡œ, í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” ê° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì „ì— `KafkaCleanUp.resetAllTestTopics()`ì™€ `resetAllConsumerGroups()`ë¥¼ í˜¸ì¶œí•˜ì—¬ í† í”½ê³¼ Consumer Groupì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ë§¤ í…ŒìŠ¤íŠ¸ë§ˆë‹¤ `offset.reset: latest` ì„¤ì •ì´ ì ìš©ë˜ì–´, ì´ì „ í…ŒìŠ¤íŠ¸ì˜ ë©”ì‹œì§€ê°€ ë‹¤ìŒ í…ŒìŠ¤íŠ¸ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ ë°©ì‹ì€ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œê°„ì„ ì¦ê°€ì‹œí‚¬ ìˆ˜ ìˆê³ , í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í…ŒìŠ¤íŠ¸ ê²©ë¦¬ ì „ëµ(ì˜ˆ: ê° í…ŒìŠ¤íŠ¸ë§ˆë‹¤ ê³ ìœ í•œ Consumer Group ID ì‚¬ìš©, ë˜ëŠ” í…ŒìŠ¤íŠ¸ìš© ë³„ë„ í† í”½ ì‚¬ìš©)ì´ ë” ë‚˜ì€ì§€ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.

- íŒŒí‹°ì…˜ í‚¤ë¥¼ `productId` ë˜ëŠ” `orderId`ë¡œ ì„¤ì •í–ˆëŠ”ë°, ì´ë¡œ ì¸í•œ íŒŒí‹°ì…˜ ë¶ˆê· í˜• ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, íŠ¹ì • ìƒí’ˆì— ëŒ€í•œ ì´ë²¤íŠ¸ê°€ ë§¤ìš° ë§ìœ¼ë©´ í•´ë‹¹ ìƒí’ˆì˜ íŒŒí‹°ì…˜ì—ë§Œ ë©”ì‹œì§€ê°€ ì§‘ì¤‘ë˜ì–´ ë‹¤ë¥¸ íŒŒí‹°ì…˜ì€ ë¹„ì–´ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ í˜„ì¬ êµ¬í˜„ì—ì„œëŠ” íŒŒí‹°ì…˜ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆœì„œë¥¼ ë³´ì¥í•˜ëŠ” ê²ƒì´ ë” ì¤‘ìš”í•˜ë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤. ë§Œì•½ íŒŒí‹°ì…˜ ë¶ˆê· í˜•ì´ ì‹¬ê°í•œ ë¬¸ì œê°€ ëœë‹¤ë©´, íŒŒí‹°ì…˜ í‚¤ë¥¼ í•´ì‹œ í•¨ìˆ˜ë¡œ ë³€í™˜í•˜ê±°ë‚˜, ë³µí•© í‚¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ë“±ì˜ ë°©ì•ˆì„ ê³ ë ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- íŒŒí‹°ì…˜ í‚¤ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ëœë¤ í‚¤ë¥¼ ì‚¬ìš©í•˜ë©´ ì–´ë–¤ ë¬¸ì œê°€ ë°œìƒí• ê¹Œìš”? ì˜ˆë¥¼ ë“¤ì–´, ê°™ì€ ìƒí’ˆì— ëŒ€í•œ `LikeAdded`ì™€ `LikeRemoved` ì´ë²¤íŠ¸ê°€ ì„œë¡œ ë‹¤ë¥¸ íŒŒí‹°ì…˜ì— ë°œí–‰ë˜ë©´, Consumerê°€ `LikeRemoved`ë¥¼ ë¨¼ì € ì²˜ë¦¬í•˜ê³  `LikeAdded`ë¥¼ ë‚˜ì¤‘ì— ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš° ì¢‹ì•„ìš” ìˆ˜ê°€ ìŒìˆ˜ê°€ ë˜ê±°ë‚˜ ì˜ëª»ëœ ë©”íŠ¸ë¦­ì´ ìƒì„±ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ íŒŒí‹°ì…˜ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°™ì€ aggregate rootì— ëŒ€í•œ ì´ë²¤íŠ¸ëŠ” í•­ìƒ ê°™ì€ íŒŒí‹°ì…˜ì—ì„œ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ë˜ë„ë¡ í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.

---

### êµ¬í˜„ ì„¸ë¶€ì‚¬í•­

#### 1. ë‚´ë¶€ ì´ë²¤íŠ¸ì™€ ì™¸ë¶€ ì´ë²¤íŠ¸ì˜ êµ¬ë¶„

**ë°°ê²½:**
ê¸°ì¡´ì—ëŠ” JVM ë‚´ì—ì„œ ì²˜ë¦¬ ê°€ëŠ¥í•œ ëŠìŠ¨í•œ ì—°ê²°ì„ ìœ„í•´ Spring Application Eventë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì£¼ë¬¸ ìƒì„± ì‹œ ì¬ê³  ì°¨ê°ì´ë‚˜ í¬ì¸íŠ¸ ì ë¦½ ë“±ì˜ ë¡œì§ì€ ê°™ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ë‚´ì—ì„œ ì²˜ë¦¬ë˜ë¯€ë¡œ Application Eventë¡œ ì¶©ë¶„í–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ë²ˆì—ëŠ” ì™¸ë¶€ ì‹œìŠ¤í…œ(ì§‘ê³„ ì„œë¹„ìŠ¤)ê³¼ì˜ í†µì‹ ì´ í•„ìš”í•˜ë¯€ë¡œ, JVMì„ ë²—ì–´ë‚˜ ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•  ìˆ˜ ìˆëŠ” Kafkaë¥¼ ì‚¬ìš©í•˜ë„ë¡ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.

**ë‚´ë¶€ ì´ë²¤íŠ¸ (Application Event):**
- ê°™ì€ JVM ë‚´ì—ì„œ ì²˜ë¦¬ë˜ëŠ” ì´ë²¤íŠ¸
- ì˜ˆ: ì£¼ë¬¸ ìƒì„± â†’ ì¬ê³  ì°¨ê°, í¬ì¸íŠ¸ ì ë¦½ ë“±
- Springì˜ `ApplicationEventPublisher`ë¥¼ í†µí•´ ë°œí–‰
- ë™ê¸° ë˜ëŠ” ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬ ê°€ëŠ¥
- íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì²˜ë¦¬ë˜ë¯€ë¡œ ì¼ê´€ì„± ë³´ì¥ì´ ìƒëŒ€ì ìœ¼ë¡œ ì‰¬ì›€

**ì™¸ë¶€ ì´ë²¤íŠ¸ (Kafka Event):**
- ë‹¤ë¥¸ ì„œë¹„ìŠ¤(ì§‘ê³„ ì„œë¹„ìŠ¤)ë¡œ ì „ë‹¬ë˜ì–´ì•¼ í•˜ëŠ” ì´ë²¤íŠ¸
- ì˜ˆ: ì£¼ë¬¸ ìƒì„± â†’ íŒë§¤ëŸ‰ ì§‘ê³„, ì¢‹ì•„ìš” ì¶”ê°€ â†’ ì¢‹ì•„ìš” ìˆ˜ ì§‘ê³„ ë“±
- Kafkaë¥¼ í†µí•´ ë„¤íŠ¸ì›Œí¬ë¡œ ì „ë‹¬
- ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬ë˜ë©°, ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë‚˜ ì„œë¹„ìŠ¤ ë‹¤ìš´ ë“±ì˜ ìƒí™©ì„ ê³ ë ¤í•´ì•¼ í•¨
- íŠ¸ëœì­ì…˜ ê²½ê³„ë¥¼ ë„˜ì–´ì„œë¯€ë¡œ ì¼ê´€ì„± ë³´ì¥ì´ ë³µì¡í•¨ (Outbox íŒ¨í„´ í•„ìš”)

**êµ¬ì¡°:**
```
ë„ë©”ì¸ ë¡œì§ (ì˜ˆ: ì£¼ë¬¸ ìƒì„±)
    â†“
ApplicationEvent ë°œí–‰ (JVM ë‚´ë¶€)
    â†“
OutboxBridgeEventListener (ApplicationEvent â†’ OutboxEvent ë³€í™˜)
    - @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    - ë„ë©”ì¸ íŠ¸ëœì­ì…˜ê³¼ ê°™ì€ íŠ¸ëœì­ì…˜ì—ì„œ OutboxEvent ì €ì¥
    â†“
OutboxEvent (DB ì €ì¥, PENDING ìƒíƒœ)
    â†“
OutboxEventPublisher (ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì£¼ê¸°ì ìœ¼ë¡œ PENDING ì´ë²¤íŠ¸ ì½ê¸°)
    - @Scheduled(fixedDelay = 1000)
    - Kafkaë¡œ ë°œí–‰ í›„ PUBLISHED ìƒíƒœë¡œ ë³€ê²½
    â†“
Kafka Topic (like-events, order-events, product-events)
    â†“
ProductMetricsConsumer (ì§‘ê³„ ì„œë¹„ìŠ¤, ë‹¤ë¥¸ JVM)
    - ì´ë²¤íŠ¸ ìˆ˜ì·¨ ë° ë©”íŠ¸ë¦­ ì§‘ê³„
    - event_handled í…Œì´ë¸”ë¡œ ë©±ë“±ì„± ë³´ì¥
    - version í•„ë“œë¡œ ìµœì‹  ì´ë²¤íŠ¸ë§Œ ë°˜ì˜
```

**ê´€ë ¨ ì½”ë“œ:**
```java
// ë‚´ë¶€ ì´ë²¤íŠ¸: ApplicationEvent (JVM ë‚´ë¶€)
applicationEventPublisher.publishEvent(new OrderEvent.OrderCreated(...));

// ì™¸ë¶€ ì´ë²¤íŠ¸: ApplicationEvent â†’ OutboxEvent â†’ Kafka
@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
public void handleOrderCreated(OrderEvent.OrderCreated event) {
    outboxEventService.saveEvent(/* OutboxEventë¡œ ë³€í™˜í•˜ì—¬ DB ì €ì¥ */);
}

@Scheduled(fixedDelay = 1000)
public void publishPendingEvents() {
    // PENDING ì´ë²¤íŠ¸ë¥¼ ì½ì–´ Kafkaë¡œ ë°œí–‰
}
```

#### 2. Producer ì„¤ì •: At Least Once ë³´ì¥ ë° ì´ë²¤íŠ¸ ìƒì„± ì‹¤íŒ¨ ì²˜ë¦¬

**ë°°ê²½:**
ì™¸ë¶€ ì‹œìŠ¤í…œê³¼ì˜ í†µì‹ ì´ê¸° ë•Œë¬¸ì— DBì—ì„œ ë°ì´í„°ë¥¼ ì§ì ‘ ì¡°íšŒí•˜ê±°ë‚˜, ê¸°ì¡´ì˜ ì„œë¹„ìŠ¤ ë¡œì§ì„ ì‚¬ìš©í•˜ì—¬ ê²€ì¦ì²˜ë¦¬í•˜ê¸°ëŠ” ì–´ë ¤ìš´ ìƒí™©ì…ë‹ˆë‹¤. ë”°ë¼ì„œ ì´ë²¤íŠ¸ publisher ìì²´ì˜ ì„¤ì •ì„ í†µí•´ ë©”ì‹œì§€ ìœ ì‹¤ì„ ë°©ì§€í•˜ê³ , Consumer ì¸¡ì—ì„œ ë©±ë“± ì²˜ë¦¬ë¥¼ í†µí•´ ì¤‘ë³µì„ ë°©ì§€í•˜ëŠ” êµ¬ì¡°ë¡œ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.

**ì„¤ì • ë‚´ìš©:**
- `acks=all`: Producerê°€ ë©”ì‹œì§€ë¥¼ ë°œí–‰í•  ë•Œ, ëª¨ë“  ë¦¬í”Œë¦¬ì¹´ì— ì“°ê¸°ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ë¦¬í”Œë¦¬ì¹´ ì¤‘ í•˜ë‚˜ê°€ ì‹¤íŒ¨í•˜ë”ë¼ë„ ë‹¤ë¥¸ ë¦¬í”Œë¦¬ì¹´ì— ë©”ì‹œì§€ê°€ ì €ì¥ë˜ì–´ ìœ ì‹¤ì„ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- `enable.idempotence=true`: Producerê°€ ë™ì¼í•œ ë©”ì‹œì§€ë¥¼ ì—¬ëŸ¬ ë²ˆ ë°œí–‰í•˜ë”ë¼ë„ Kafka ë¸Œë¡œì»¤ê°€ ì¤‘ë³µì„ ì œê±°í•˜ì—¬ í•œ ë²ˆë§Œ ì €ì¥í•˜ë„ë¡ í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì¸í•œ ì¬ì‹œë„ ì‹œ ì¤‘ë³µ ë©”ì‹œì§€ê°€ ì €ì¥ë˜ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
- `max.in.flight.requests.per.connection=5`: `idempotence=true`ì¼ ë•Œ í•„ìˆ˜ ì„¤ì •ì…ë‹ˆë‹¤. ë™ì‹œì— ì „ì†¡í•  ìˆ˜ ìˆëŠ” ë¯¸í™•ì¸ ìš”ì²­ì˜ ìµœëŒ€ ê°œìˆ˜ë¥¼ ì œí•œí•©ë‹ˆë‹¤.

**ê´€ë ¨ ì½”ë“œ:**
```yaml
# modules/kafka/src/main/resources/kafka.yml
spring:
  kafka:
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      retries: 3
      properties:
        acks: all                    # ëª¨ë“  ë¦¬í”Œë¦¬ì¹´ì— ì“°ê¸° í™•ì¸ (At Least Once ë³´ì¥)
        enable.idempotence: true     # ì¤‘ë³µ ë°©ì§€ (At Least Once ë³´ì¥)
        max.in.flight.requests.per.connection: 5  # idempotence=trueì¼ ë•Œ í•„ìˆ˜
```

**ê³ ë¯¼í•œ ì :**
- `acks=all`ì€ ë©”ì‹œì§€ ìœ ì‹¤ì„ ë°©ì§€í•˜ì§€ë§Œ, ëª¨ë“  ë¦¬í”Œë¦¬ì¹´ì— ì“°ê¸°ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°í•˜ë¯€ë¡œ ì§€ì—° ì‹œê°„ì´ ì¦ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ë©”ì‹œì§€ ìœ ì‹¤ì„ ë°©ì§€í•˜ëŠ” ê²ƒì´ ë” ì¤‘ìš”í•˜ë‹¤ê³  íŒë‹¨í•˜ì—¬ `acks=all`ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.
- `enable.idempotence=true`ëŠ” Producer ì¸¡ì—ì„œ ì¤‘ë³µì„ ì œê±°í•˜ì§€ë§Œ, ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë‚˜ Consumer ì¬ì‹œì‘ ë“±ì˜ ìƒí™©ì—ì„œ ë™ì¼í•œ ë©”ì‹œì§€ê°€ ì—¬ëŸ¬ ë²ˆ ì „ë‹¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ Consumer ì¸¡ì—ì„œë„ ë©±ë“± ì²˜ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.

#### 3. Consumer ì„¤ì •: Manual Ack ì²˜ë¦¬

**ë°°ê²½:**
Consumerê°€ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” ê³¼ì •ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë§Œì•½ ìë™ ì»¤ë°‹ì„ ì‚¬ìš©í•˜ë©´, ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ê¸° ì „ì— offsetì´ ì»¤ë°‹ë˜ì–´ ì´ë²¤íŠ¸ê°€ ìœ ì‹¤ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°˜ëŒ€ë¡œ ì´ë²¤íŠ¸ ì²˜ë¦¬ ì‹¤íŒ¨ ì‹œì—ë„ offsetì´ ì»¤ë°‹ë˜ì§€ ì•Šë„ë¡ í•˜ì—¬ ì¬ì²˜ë¦¬ê°€ ê°€ëŠ¥í•˜ë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤.

**ì„¤ì • ë‚´ìš©:**
- `enable-auto-commit: false`: ìë™ ì»¤ë°‹ì„ ë¹„í™œì„±í™”í•˜ì—¬ ìˆ˜ë™ ì»¤ë°‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
- `ack-mode: manual`: ìˆ˜ë™ ì»¤ë°‹ ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ì—¬, ì´ë²¤íŠ¸ ì²˜ë¦¬ ì„±ê³µ í›„ì—ë§Œ `Acknowledgment.acknowledge()`ë¥¼ í˜¸ì¶œí•˜ì—¬ offsetì„ ì»¤ë°‹í•©ë‹ˆë‹¤.

**ì²˜ë¦¬ íë¦„:**
1. Consumerê°€ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•©ë‹ˆë‹¤.
2. ê° ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤ (ë©±ë“±ì„± ì²´í¬, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤í–‰, event_handled í…Œì´ë¸”ì— ê¸°ë¡).
3. ëª¨ë“  ë©”ì‹œì§€ ì²˜ë¦¬ ì™„ë£Œ í›„ `acknowledgment.acknowledge()`ë¥¼ í˜¸ì¶œí•˜ì—¬ offsetì„ ì»¤ë°‹í•©ë‹ˆë‹¤.
4. ë§Œì•½ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ `acknowledgment.acknowledge()`ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šì•„ offsetì´ ì»¤ë°‹ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ, Consumerê°€ ì¬ì‹œì‘ë˜ê±°ë‚˜ ë‹¤ìŒ poll ì‹œ ë™ì¼í•œ ë©”ì‹œì§€ë¥¼ ë‹¤ì‹œ ë°›ì•„ ì¬ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ê´€ë ¨ ì½”ë“œ:**
```yaml
# modules/kafka/src/main/resources/kafka.yml
spring:
  kafka:
    consumer:
      group-id: loopers-default-consumer
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.apache.kafka.common.serialization.ByteArrayDeserializer
      properties:
        enable-auto-commit: false    # ìë™ ì»¤ë°‹ ë¹„í™œì„±í™”
    listener:
      ack-mode: manual                # ìˆ˜ë™ ì»¤ë°‹ ëª¨ë“œ
```

```java
// ProductMetricsConsumer.java - ì²˜ë¦¬ ì„±ê³µ í›„ì—ë§Œ ìˆ˜ë™ ì»¤ë°‹
@KafkaListener(topics = "like-events")
public void consumeLikeEvents(..., Acknowledgment acknowledgment) {
    // ì´ë²¤íŠ¸ ì²˜ë¦¬ ë¡œì§
    acknowledgment.acknowledge();  // ì„±ê³µ ì‹œì—ë§Œ ì»¤ë°‹
}
```

**ê³ ë¯¼í•œ ì :**
- Manual Ackë¥¼ ì‚¬ìš©í•˜ë©´ ì´ë²¤íŠ¸ ì²˜ë¦¬ ì„±ê³µ í›„ì—ë§Œ offsetì´ ì»¤ë°‹ë˜ë¯€ë¡œ, ì²˜ë¦¬ ì‹¤íŒ¨ ì‹œ ì¬ì²˜ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ Consumerê°€ ì¬ì‹œì‘ë˜ê±°ë‚˜ ì¥ì• ê°€ ë°œìƒí•˜ë©´ ì²˜ë¦¬ ì¤‘ì´ë˜ ë©”ì‹œì§€ë“¤ì´ ë‹¤ì‹œ ì²˜ë¦¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ë©±ë“± ì²˜ë¦¬ê°€ í•„ìˆ˜ì ì…ë‹ˆë‹¤.
- ë°°ì¹˜ ì²˜ë¦¬ ì‹œ ëª¨ë“  ë©”ì‹œì§€ ì²˜ë¦¬ ì™„ë£Œ í›„ í•œ ë²ˆì— ì»¤ë°‹í•˜ëŠ” ë°©ì‹ê³¼, ê° ë©”ì‹œì§€ ì²˜ë¦¬ í›„ ê°œë³„ì ìœ¼ë¡œ ì»¤ë°‹í•˜ëŠ” ë°©ì‹ ì¤‘ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜„ì¬ëŠ” ë°°ì¹˜ ì²˜ë¦¬ í›„ í•œ ë²ˆì— ì»¤ë°‹í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í–ˆëŠ”ë°, ì´ëŠ” ì„±ëŠ¥ìƒ ìœ ë¦¬í•˜ì§€ë§Œ ì¼ë¶€ ë©”ì‹œì§€ ì²˜ë¦¬ ì‹¤íŒ¨ ì‹œ ì „ì²´ ë°°ì¹˜ê°€ ì¬ì²˜ë¦¬ë©ë‹ˆë‹¤. ê°œë³„ ì»¤ë°‹ ë°©ì‹ì€ ì„±ëŠ¥ì´ ë–¨ì–´ì§€ì§€ë§Œ ì‹¤íŒ¨í•œ ë©”ì‹œì§€ë§Œ ì¬ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### 4. ë©±ë“±ì„± ì²˜ë¦¬: event_handled í…Œì´ë¸”

**ë°°ê²½:**
Kafkaì˜ At Least Once ë³´ì¥ê³¼ Manual Ack ì²˜ë¦¬ë¡œ ì¸í•´, ë™ì¼í•œ ì´ë²¤íŠ¸ê°€ ì—¬ëŸ¬ ë²ˆ ì „ë‹¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ Consumerê°€ ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ë¡œ ì‹¤í–‰ë˜ëŠ” ê²½ìš°, ë™ì‹œì— ê°™ì€ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ë ¤ê³  í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ìƒí™©ì—ì„œ ì¤‘ë³µ ì²˜ë¦¬ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ `event_handled` í…Œì´ë¸”ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

**êµ¬í˜„ ë°©ì‹:**
- ê° ì´ë²¤íŠ¸ì— ê³ ìœ í•œ UUID ê¸°ë°˜ `eventId`ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.
- Consumerì—ì„œ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ê¸° ì „ì— `event_handled` í…Œì´ë¸”ì—ì„œ í•´ë‹¹ `eventId`ê°€ ì´ë¯¸ ì²˜ë¦¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
- ì´ë¯¸ ì²˜ë¦¬ëœ ê²½ìš° ìŠ¤í‚µí•˜ê³ , ì²˜ë¦¬ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì‹¤í–‰í•œ í›„ `event_handled` í…Œì´ë¸”ì— ê¸°ë¡ì„ ì €ì¥í•©ë‹ˆë‹¤.
- `event_handled` í…Œì´ë¸”ì˜ `event_id` ì»¬ëŸ¼ì— UNIQUE ì œì•½ì¡°ê±´ì„ ì„¤ì •í•˜ì—¬, ë™ì‹œì„± ìƒí™©ì—ì„œë„ ì¤‘ë³µ ì²˜ë¦¬ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.

**ê´€ë ¨ ì½”ë“œ:**
```java
// EventHandled.java - eventIdì— UNIQUE ì œì•½ì¡°ê±´
@Entity
public class EventHandled {
    @Id
    @Column(unique = true)
    private String eventId;  // UNIQUE ì œì•½ì¡°ê±´ìœ¼ë¡œ ë™ì‹œì„± ë³´ì¥
}

// ProductMetricsConsumer.java - ì¤‘ë³µ ì²´í¬
if (eventHandledService.isAlreadyHandled(eventId)) continue;
productMetricsService.incrementLikeCount(...);
eventHandledService.markAsHandled(eventId, ...);  // UNIQUE ì œì•½ì¡°ê±´ìœ¼ë¡œ ì¤‘ë³µ ë°©ì§€
```

**ê³ ë¯¼í•œ ì :**
- `event_handled` í…Œì´ë¸”ì„ DBë¡œ êµ¬í˜„í–ˆì§€ë§Œ, Redisë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒë„ ê³ ë ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. RedisëŠ” TTLì„ ì‰½ê²Œ ì„¤ì •í•  ìˆ˜ ìˆê³  ì¡°íšŒ ì„±ëŠ¥ì´ ë¹ ë¥´ì§€ë§Œ, ì˜ì†ì„±ì´ ë³´ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. DBëŠ” ì˜ì†ì„±ì´ ë³´ì¥ë˜ì§€ë§Œ TTL ì„¤ì •ì´ ë³µì¡í•˜ê³  ì¡°íšŒ ì„±ëŠ¥ì´ ìƒëŒ€ì ìœ¼ë¡œ ëŠë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜„ì¬ëŠ” DBë¥¼ ì„ íƒí–ˆëŠ”ë°, ì´ëŠ” ì˜ì†ì„±ì´ ì¤‘ìš”í•˜ê³  TTLì€ ë³„ë„ ì•„ì¹´ì´ë¹™ ì „ëµìœ¼ë¡œ í•´ê²°í•  ìˆ˜ ìˆë‹¤ê³  íŒë‹¨í–ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
- `event_handled` í…Œì´ë¸”ì´ ê³„ì† ì¦ê°€í•˜ëŠ” ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì‹œê°„ì´ ì§€ë‚˜ë©´ì„œ ì´ í…Œì´ë¸”ì˜ ë°ì´í„°ê°€ ë¬´í•œì • ì¦ê°€í•˜ê²Œ ë˜ëŠ”ë°, ì´ëŠ” ìŠ¤í† ë¦¬ì§€ ë¹„ìš©ê³¼ ì¡°íšŒ ì„±ëŠ¥ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. TTLì„ ì„¤ì •í•˜ì—¬ ì¼ì • ê¸°ê°„ì´ ì§€ë‚œ ë ˆì½”ë“œë¥¼ ìë™ìœ¼ë¡œ ì‚­ì œí•˜ê±°ë‚˜, ì•„ì¹´ì´ë¹™ ì „ëµì„ ìˆ˜ë¦½í•˜ì—¬ ì˜¤ë˜ëœ ë°ì´í„°ë¥¼ ë³„ë„ í…Œì´ë¸”ë¡œ ì´ë™ì‹œí‚¤ëŠ” ë“±ì˜ ë°©ì•ˆì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### 5. ë²„ì „ ê¸°ë°˜ ìµœì‹  ì´ë²¤íŠ¸ë§Œ ë°˜ì˜

**ë°°ê²½:**
ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì´ë‚˜ íŒŒí‹°ì…˜ ìˆœì„œ ë¬¸ì œë¡œ ì¸í•´, ì´ë²¤íŠ¸ê°€ ë°œìƒí•œ ìˆœì„œì™€ Consumerê°€ ë°›ëŠ” ìˆœì„œê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, `version=3` ì´ë²¤íŠ¸ê°€ ë¨¼ì € ë„ì°©í•˜ê³  `version=2` ì´ë²¤íŠ¸ê°€ ë‚˜ì¤‘ì— ë„ì°©í•˜ëŠ” ê²½ìš°, `version=2` ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ë©´ ì´ë¯¸ `version=3`ìœ¼ë¡œ ì—…ë°ì´íŠ¸ëœ ë©”íŠ¸ë¦­ì„ ë®ì–´ì“°ê²Œ ë˜ì–´ ì˜ëª»ëœ ìƒíƒœê°€ ë©ë‹ˆë‹¤.

**í•´ê²° ë°©ì•ˆ:**
- `OutboxEvent`ì— `aggregateId`ë³„ë¡œ ìˆœì°¨ì ìœ¼ë¡œ ì¦ê°€í•˜ëŠ” `version` í•„ë“œë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.
- ì´ `version`ì€ Kafka ë©”ì‹œì§€ í—¤ë”ì— í¬í•¨ë˜ì–´ Consumerë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.
- Consumerì—ì„œ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•  ë•Œ, `ProductMetrics`ì˜ í˜„ì¬ `version`ê³¼ ì´ë²¤íŠ¸ì˜ `version`ì„ ë¹„êµí•©ë‹ˆë‹¤.
- ì´ë²¤íŠ¸ì˜ `version`ì´ ë©”íŠ¸ë¦­ì˜ `version`ë³´ë‹¤ í¬ë©´ ì—…ë°ì´íŠ¸í•˜ê³ , ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ìŠ¤í‚µí•©ë‹ˆë‹¤.

**êµ¬í˜„ ë°©ì‹:**
- `OutboxEventService.saveEvent()`ì—ì„œ `aggregateId`ë³„ ìµœì‹  ë²„ì „ì„ ì¡°íšŒí•œ í›„ +1í•˜ì—¬ ìƒˆë¡œìš´ ë²„ì „ì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
- `ProductMetrics`ì—ë„ `version` í•„ë“œë¥¼ ë‘ê³ , ì—…ë°ì´íŠ¸í•  ë•Œë§ˆë‹¤ ì¦ê°€ì‹œí‚µë‹ˆë‹¤.
- `ProductMetrics.shouldUpdate()` ë©”ì„œë“œë¡œ ì´ë²¤íŠ¸ ë²„ì „ê³¼ ë©”íŠ¸ë¦­ ë²„ì „ì„ ë¹„êµí•˜ì—¬, ì´ë²¤íŠ¸ê°€ ìµœì‹ ì¸ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

**ì „ì²´ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨:**
```
[ë„ë©”ì¸ ì´ë²¤íŠ¸ ë°œìƒ]
    â†“
[OutboxBridgeEventListener]
    â†“
[OutboxEventService.saveEvent()]
    â”œâ”€ aggregateIdë³„ ìµœì‹  ë²„ì „ ì¡°íšŒ (DB)
    â”œâ”€ ë²„ì „ +1 ê³„ì‚°
    â””â”€ OutboxEventì— version ì €ì¥ (DB)
    â†“
[OutboxEventPublisher (ìŠ¤ì¼€ì¤„ëŸ¬, 1ì´ˆë§ˆë‹¤)]
    â”œâ”€ PENDING ì´ë²¤íŠ¸ ì¡°íšŒ
    â”œâ”€ Kafka ë©”ì‹œì§€ í—¤ë”ì— version ì¶”ê°€
    â””â”€ Kafkaë¡œ ë°œí–‰
    â†“
[ProductMetricsConsumer]
    â”œâ”€ Kafka í—¤ë”ì—ì„œ version ì¶”ì¶œ
    â”œâ”€ ProductMetricsServiceì— version ì „ë‹¬
    â””â”€ version ë¹„êµë¡œ ìµœì‹  ì´ë²¤íŠ¸ë§Œ ë°˜ì˜
```

**í•µì‹¬ ì½”ë“œ ìœ„ì¹˜:**

**1) ë²„ì „ ìƒì„±: OutboxEventService.saveEvent() (59-60ì¤„)**
```java
// ì§‘ê³„ IDë³„ ìµœì‹  ë²„ì „ ì¡°íšŒ í›„ +1
Long latestVersion = outboxEventRepository.findLatestVersionByAggregateId(aggregateId, aggregateType);
Long nextVersion = latestVersion + 1L;
```

**2) Kafka í—¤ë”ì— ì¶”ê°€: OutboxEventPublisher.publishEvent() (99-102ì¤„)**
```java
// versionì´ ìˆìœ¼ë©´ í—¤ë”ì— ì¶”ê°€
if (event.getVersion() != null) {
    messageBuilder.setHeader("version", event.getVersion());
}
```

**3) Consumerì—ì„œ ì¶”ì¶œ: ProductMetricsConsumer.extractVersion() (374-387ì¤„)**
```java
// Kafka í—¤ë”ì—ì„œ version ì¶”ì¶œ
Header header = record.headers().lastHeader(VERSION_HEADER);
return Long.parseLong(new String(header.value(), StandardCharsets.UTF_8));
```

**4) ë²„ì „ ë¹„êµ: ProductMetricsServiceì—ì„œ eventVersionê³¼ metrics.version ë¹„êµí•˜ì—¬ ìµœì‹  ì´ë²¤íŠ¸ë§Œ ë°˜ì˜**

ì´ë ‡ê²Œ `aggregateId`ë³„ë¡œ ìˆœì°¨ì ì¸ ë²„ì „ì´ ìƒì„±ë˜ì–´ Kafka í—¤ë”ë¡œ ì „ë‹¬ë˜ê³ , Consumerì—ì„œ ìµœì‹  ì´ë²¤íŠ¸ë§Œ ë°˜ì˜í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.

**ê´€ë ¨ ì½”ë“œ:**
```java
// OutboxEventService.java - aggregateIdë³„ ìˆœì°¨ì  version ë¶€ì—¬
Long nextVersion = findLatestVersionByAggregateId(...) + 1L;

// ProductMetrics.java - version ë¹„êµë¡œ ìµœì‹  ì´ë²¤íŠ¸ë§Œ ë°˜ì˜
public boolean shouldUpdate(Long eventVersion) {
    return eventVersion > this.version;  // ì´ë²¤íŠ¸ ë²„ì „ì´ ë” í¬ë©´ ì—…ë°ì´íŠ¸
}

// ProductMetricsService.java
if (!metrics.shouldUpdate(eventVersion)) return;  // ì˜¤ë˜ëœ ì´ë²¤íŠ¸ ìŠ¤í‚µ
metrics.incrementLikeCount();
```

**ê³ ë¯¼í•œ ì :**
- `version` í•„ë“œëŠ” `aggregateId`ë³„ë¡œ ìë™ ì¦ê°€í•˜ë„ë¡ êµ¬í˜„í–ˆëŠ”ë°, ì´ ë°©ì‹ì˜ ì¥ì ì€ ê°„ë‹¨í•˜ê³  ìˆœì°¨ì ì¸ ë²„ì „ ê´€ë¦¬ê°€ ê°€ëŠ¥í•˜ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. í•˜ì§€ë§Œ `updatedAt` ê¸°ë°˜ ë°©ì‹ê³¼ ë¹„êµí–ˆì„ ë•Œ, `updatedAt`ì€ ì‹œê°„ ê¸°ë°˜ì´ë¯€ë¡œ ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì´ë‚˜ ì‹œìŠ¤í…œ ì‹œê°„ ë¶ˆì¼ì¹˜ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°˜ë©´ `version`ì€ ìˆœì°¨ì ìœ¼ë¡œ ì¦ê°€í•˜ë¯€ë¡œ ì´ëŸ¬í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë§Œ, `aggregateId`ë³„ë¡œ ë³„ë„ì˜ ë²„ì „ì„ ê´€ë¦¬í•´ì•¼ í•˜ë¯€ë¡œ ë³µì¡ë„ê°€ ì¦ê°€í•©ë‹ˆë‹¤.
- `version` í•„ë“œê°€ `aggregateId`ë³„ë¡œ ê´€ë¦¬ë˜ë¯€ë¡œ, ê°™ì€ `aggregateId`ì— ëŒ€í•œ ì´ë²¤íŠ¸ëŠ” ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ íŒŒí‹°ì…˜ í‚¤ë¥¼ `aggregateId`ë¡œ ì„¤ì •í–ˆìœ¼ë¯€ë¡œ, ê°™ì€ `aggregateId`ì— ëŒ€í•œ ì´ë²¤íŠ¸ëŠ” ê°™ì€ íŒŒí‹°ì…˜ì—ì„œ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ ì´ ë¬¸ì œëŠ” í•´ê²°ë©ë‹ˆë‹¤.

#### 6. íŒŒí‹°ì…˜ í‚¤ ì„¤ì •

**ë°°ê²½:**
KafkaëŠ” ê¸°ë³¸ì ìœ¼ë¡œ íŒŒí‹°ì…˜ ë‚´ì—ì„œë§Œ ìˆœì„œë¥¼ ë³´ì¥í•˜ê³ , ì„œë¡œ ë‹¤ë¥¸ íŒŒí‹°ì…˜ ê°„ì˜ ìˆœì„œëŠ” ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ê°™ì€ aggregate rootì— ëŒ€í•œ ì´ë²¤íŠ¸ëŠ” ê°™ì€ íŒŒí‹°ì…˜ì—ì„œ ì²˜ë¦¬ë˜ì–´ì•¼ ìˆœì„œê°€ ë³´ì¥ë©ë‹ˆë‹¤.

**ì„¤ì • ë‚´ìš©:**
- `like-events`, `product-events`: `productId`ë¥¼ íŒŒí‹°ì…˜ í‚¤ë¡œ ì‚¬ìš©í•˜ì—¬, ê°™ì€ ìƒí’ˆì— ëŒ€í•œ ì´ë²¤íŠ¸ëŠ” í•­ìƒ ê°™ì€ íŒŒí‹°ì…˜ì—ì„œ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
- `order-events`: `orderId`ë¥¼ íŒŒí‹°ì…˜ í‚¤ë¡œ ì‚¬ìš©í•˜ì—¬, ê°™ì€ ì£¼ë¬¸ì— ëŒ€í•œ ì´ë²¤íŠ¸ëŠ” í•­ìƒ ê°™ì€ íŒŒí‹°ì…˜ì—ì„œ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.

**ê´€ë ¨ ì½”ë“œ:**
```java
// OutboxBridgeEventListener.java - íŒŒí‹°ì…˜ í‚¤ ì„¤ì •
outboxEventService.saveEvent(..., partitionKey: productId.toString());  // like-events, product-events
outboxEventService.saveEvent(..., partitionKey: orderId.toString());     // order-events

// OutboxEventPublisher.java - Kafka ë©”ì‹œì§€ì— íŒŒí‹°ì…˜ í‚¤ ì„¤ì •
messageBuilder.setHeader(KafkaHeaders.KEY, event.getPartitionKey());
```

**ê³ ë¯¼í•œ ì :**
- íŒŒí‹°ì…˜ í‚¤ë¥¼ `productId` ë˜ëŠ” `orderId`ë¡œ ì„¤ì •í–ˆëŠ”ë°, ì´ë¡œ ì¸í•œ íŒŒí‹°ì…˜ ë¶ˆê· í˜• ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, íŠ¹ì • ìƒí’ˆì— ëŒ€í•œ ì´ë²¤íŠ¸ê°€ ë§¤ìš° ë§ìœ¼ë©´ í•´ë‹¹ ìƒí’ˆì˜ íŒŒí‹°ì…˜ì—ë§Œ ë©”ì‹œì§€ê°€ ì§‘ì¤‘ë˜ì–´ ë‹¤ë¥¸ íŒŒí‹°ì…˜ì€ ë¹„ì–´ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ í˜„ì¬ êµ¬í˜„ì—ì„œëŠ” íŒŒí‹°ì…˜ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆœì„œë¥¼ ë³´ì¥í•˜ëŠ” ê²ƒì´ ë” ì¤‘ìš”í•˜ë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤. ë§Œì•½ íŒŒí‹°ì…˜ ë¶ˆê· í˜•ì´ ì‹¬ê°í•œ ë¬¸ì œê°€ ëœë‹¤ë©´, íŒŒí‹°ì…˜ í‚¤ë¥¼ í•´ì‹œ í•¨ìˆ˜ë¡œ ë³€í™˜í•˜ê±°ë‚˜, ë³µí•© í‚¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ë“±ì˜ ë°©ì•ˆì„ ê³ ë ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- íŒŒí‹°ì…˜ í‚¤ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ëœë¤ í‚¤ë¥¼ ì‚¬ìš©í•˜ë©´ ì–´ë–¤ ë¬¸ì œê°€ ë°œìƒí• ê¹Œìš”? ì˜ˆë¥¼ ë“¤ì–´, ê°™ì€ ìƒí’ˆì— ëŒ€í•œ `LikeAdded`ì™€ `LikeRemoved` ì´ë²¤íŠ¸ê°€ ì„œë¡œ ë‹¤ë¥¸ íŒŒí‹°ì…˜ì— ë°œí–‰ë˜ë©´, Consumerê°€ `LikeRemoved`ë¥¼ ë¨¼ì € ì²˜ë¦¬í•˜ê³  `LikeAdded`ë¥¼ ë‚˜ì¤‘ì— ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš° ì¢‹ì•„ìš” ìˆ˜ê°€ ìŒìˆ˜ê°€ ë˜ê±°ë‚˜ ì˜ëª»ëœ ë©”íŠ¸ë¦­ì´ ìƒì„±ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ íŒŒí‹°ì…˜ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°™ì€ aggregate rootì— ëŒ€í•œ ì´ë²¤íŠ¸ëŠ” í•­ìƒ ê°™ì€ íŒŒí‹°ì…˜ì—ì„œ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ë˜ë„ë¡ í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.

#### 7. í¼ë¸”ë¦¬ì…”ì™€ ì»¨ìŠˆë¨¸ê°€ ë™ì¼ ì´ë²¤íŠ¸ë¥¼ íŒë‹¨í•˜ëŠ” ê¸°ì¤€ ì„¤ì •

**ë°°ê²½ ë° ë¬¸ì œ ìƒí™©:**
aggregate root id(ì˜ˆ: `productId`, `orderId`)ë§Œìœ¼ë¡œëŠ” í•´ë‹¹ eventê°€ ë™ì¼í•œ í•­ëª©ì„ ì§€ì •í•˜ëŠ”ì§€ ë³´ì¥í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ê°™ì€ `productId`ì— ëŒ€í•´ ì—¬ëŸ¬ ë²ˆ ì¢‹ì•„ìš”ê°€ ì¶”ê°€ë˜ë©´, ê°ê°ì€ ì„œë¡œ ë‹¤ë¥¸ ì´ë²¤íŠ¸ì´ì§€ë§Œ `productId`ë§Œìœ¼ë¡œëŠ” êµ¬ë¶„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë˜í•œ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë‚˜ Consumer ì¬ì‹œì‘ìœ¼ë¡œ ì¸í•´ ë™ì¼í•œ ì´ë²¤íŠ¸ê°€ ì—¬ëŸ¬ ë²ˆ ì „ë‹¬ë  ìˆ˜ ìˆëŠ”ë°, `productId`ë§Œìœ¼ë¡œëŠ” ì´ê²ƒì´ ì¤‘ë³µì¸ì§€ ìƒˆë¡œìš´ ì´ë²¤íŠ¸ì¸ì§€ íŒë‹¨í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

**í•´ê²° ë°©ì•ˆ:**
ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë‘ ê°€ì§€ ì‹ë³„ìë¥¼ ì¡°í•©í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤:
1. **eventId (UUID)**: ê° ì´ë²¤íŠ¸ì— ê³ ìœ í•œ UUIDë¥¼ ë¶€ì—¬í•˜ì—¬, ë™ì¼í•œ ì´ë²¤íŠ¸ëŠ” í•œ ë²ˆë§Œ ì²˜ë¦¬ë  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
2. **version**: ê°™ì€ aggregate rootì— ëŒ€í•œ ì´ë²¤íŠ¸ì˜ ìˆœì„œë¥¼ ë³´ì¥í•˜ê³ , ì˜¤ë˜ëœ ì´ë²¤íŠ¸ê°€ ìµœì‹  ìƒíƒœë¥¼ ë®ì–´ì“°ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.

**êµ¬í˜„ ì„¸ë¶€ì‚¬í•­:**

**1) eventIdë¥¼ í†µí•œ ë™ì¼ ì´ë²¤íŠ¸ íŒë‹¨:**
- `OutboxEventService.saveEvent()`ì—ì„œ ê° ì´ë²¤íŠ¸ì— UUID ê¸°ë°˜ì˜ ê³ ìœ í•œ `eventId`ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.
- ì´ `eventId`ëŠ” Kafka ë©”ì‹œì§€ í—¤ë”ì— í¬í•¨ë˜ì–´ Consumerë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.
- Consumerì—ì„œ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ê¸° ì „ì— `event_handled` í…Œì´ë¸”ì—ì„œ í•´ë‹¹ `eventId`ê°€ ì´ë¯¸ ì²˜ë¦¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
- ì´ë¯¸ ì²˜ë¦¬ëœ ê²½ìš° ìŠ¤í‚µí•˜ê³ , ì²˜ë¦¬ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì‹¤í–‰í•œ í›„ `event_handled` í…Œì´ë¸”ì— ê¸°ë¡ì„ ì €ì¥í•©ë‹ˆë‹¤.
- ì´ë ‡ê²Œ í•˜ë©´ ë™ì¼í•œ ì´ë²¤íŠ¸ê°€ ì—¬ëŸ¬ ë²ˆ ì „ë‹¬ë˜ë”ë¼ë„ í•œ ë²ˆë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.

**2) versionì„ í†µí•œ ë¶ˆí•„ìš”í•œ ì´ë²¤íŠ¸ ì²˜ë¦¬ ë°©ì§€:**
- `OutboxEventService.saveEvent()`ì—ì„œ `aggregateId`ë³„ë¡œ ìˆœì°¨ì ìœ¼ë¡œ ì¦ê°€í•˜ëŠ” `version`ì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
- ì´ `version`ì€ Kafka ë©”ì‹œì§€ í—¤ë”ì— í¬í•¨ë˜ì–´ Consumerë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.
- Consumerì—ì„œ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•  ë•Œ, `ProductMetrics`ì˜ í˜„ì¬ `version`ê³¼ ì´ë²¤íŠ¸ì˜ `version`ì„ ë¹„êµí•©ë‹ˆë‹¤.
- ì´ë²¤íŠ¸ì˜ `version`ì´ ë©”íŠ¸ë¦­ì˜ `version`ë³´ë‹¤ í¬ë©´ ì—…ë°ì´íŠ¸í•˜ê³ , ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ìŠ¤í‚µí•©ë‹ˆë‹¤.
- ì´ë ‡ê²Œ í•˜ë©´ ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì´ë‚˜ íŒŒí‹°ì…˜ ìˆœì„œ ë¬¸ì œë¡œ ì¸í•´ ì˜¤ë˜ëœ ì´ë²¤íŠ¸ê°€ ë‚˜ì¤‘ì— ë„ì°©í•˜ë”ë¼ë„, ì´ë¯¸ ë” ìµœì‹  ë²„ì „ì˜ ë©”íŠ¸ë¦­ì´ ì¡´ì¬í•˜ë©´ ì˜¤ë˜ëœ ì´ë²¤íŠ¸ëŠ” ë¬´ì‹œë©ë‹ˆë‹¤.

**ê´€ë ¨ ì½”ë“œ:**
```java
// OutboxEventService.java - eventId(UUID)ì™€ version(aggregateIdë³„ ìˆœì°¨ ì¦ê°€) ë¶€ì—¬
String eventId = UUID.randomUUID().toString();
Long nextVersion = findLatestVersionByAggregateId(...) + 1L;

// OutboxEventPublisher.java - Kafka í—¤ë”ì— eventIdì™€ version í¬í•¨
messageBuilder.setHeader("eventId", event.getEventId())
              .setHeader("version", event.getVersion());

// ProductMetricsConsumer.java - eventIdë¡œ ì¤‘ë³µ ì²´í¬, versionìœ¼ë¡œ ìµœì‹  ì´ë²¤íŠ¸ë§Œ ë°˜ì˜
String eventId = extractEventId(record);
if (eventHandledService.isAlreadyHandled(eventId)) continue;
Long eventVersion = extractVersion(record);
productMetricsService.incrementLikeCount(productId, eventVersion);  // version ë¹„êµ í¬í•¨
```

**ê³ ë¯¼í•œ ì :**
- `eventId`ì™€ `version`ì„ ëª¨ë‘ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¤‘ë³µì¼ ìˆ˜ ìˆë‹¤ëŠ” ì˜ë¬¸ì´ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ë‘ ê°€ì§€ëŠ” ì„œë¡œ ë‹¤ë¥¸ ëª©ì ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. `eventId`ëŠ” ë™ì¼í•œ ì´ë²¤íŠ¸ì˜ ì™„ì „ ì¤‘ë³µì„ ë°©ì§€í•˜ê³ , `version`ì€ ìˆœì„œê°€ ë’¤ë°”ë€ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë¡œ ì¸í•´ `version=3` ì´ë²¤íŠ¸ê°€ ë¨¼ì € ë„ì°©í•˜ê³  `version=2` ì´ë²¤íŠ¸ê°€ ë‚˜ì¤‘ì— ë„ì°©í•˜ëŠ” ê²½ìš°, `eventId`ë¡œëŠ” ì¤‘ë³µì„ ê°ì§€í•  ìˆ˜ ì—†ì§€ë§Œ `version`ìœ¼ë¡œëŠ” ì˜¤ë˜ëœ ì´ë²¤íŠ¸ì„ì„ ê°ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°˜ëŒ€ë¡œ, ë™ì¼í•œ ì´ë²¤íŠ¸ê°€ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì¸í•´ ì—¬ëŸ¬ ë²ˆ ì „ë‹¬ë˜ëŠ” ê²½ìš°, `version`ìœ¼ë¡œëŠ” ì¤‘ë³µì„ ê°ì§€í•  ìˆ˜ ì—†ì§€ë§Œ `eventId`ë¡œëŠ” ì¤‘ë³µì„ ê°ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- `aggregateId`ë§Œìœ¼ë¡œëŠ” ë™ì¼ ì´ë²¤íŠ¸ë¥¼ íŒë‹¨í•  ìˆ˜ ì—†ëŠ” ì´ìœ ëŠ”, ê°™ì€ `aggregateId`ì— ëŒ€í•´ ì—¬ëŸ¬ ë²ˆ ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ê°™ì€ ìƒí’ˆì— ëŒ€í•´ ì¢‹ì•„ìš”ê°€ ì—¬ëŸ¬ ë²ˆ ì¶”ê°€ë˜ë©´, ê°ê°ì€ ì„œë¡œ ë‹¤ë¥¸ ì´ë²¤íŠ¸ì´ì§€ë§Œ `productId`ë§Œìœ¼ë¡œëŠ” êµ¬ë¶„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ê° ì´ë²¤íŠ¸ì— ê³ ìœ í•œ `eventId`ë¥¼ ë¶€ì—¬í•˜ì—¬ êµ¬ë¶„í•´ì•¼ í•©ë‹ˆë‹¤.

- `version`ì€ `aggregateId`ë³„ë¡œ ê´€ë¦¬ë˜ë¯€ë¡œ, ê°™ì€ `aggregateId`ì— ëŒ€í•œ ì´ë²¤íŠ¸ëŠ” ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ íŒŒí‹°ì…˜ í‚¤ë¥¼ `aggregateId`ë¡œ ì„¤ì •í–ˆìœ¼ë¯€ë¡œ, ê°™ì€ `aggregateId`ì— ëŒ€í•œ ì´ë²¤íŠ¸ëŠ” ê°™ì€ íŒŒí‹°ì…˜ì—ì„œ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ ì´ ë¬¸ì œëŠ” í•´ê²°ë©ë‹ˆë‹¤.

#### 6. íŒŒí‹°ì…˜ í‚¤ ì„¤ì •

**ë°°ê²½:**
KafkaëŠ” ê¸°ë³¸ì ìœ¼ë¡œ íŒŒí‹°ì…˜ ë‚´ì—ì„œë§Œ ìˆœì„œë¥¼ ë³´ì¥í•˜ê³ , ì„œë¡œ ë‹¤ë¥¸ íŒŒí‹°ì…˜ ê°„ì˜ ìˆœì„œëŠ” ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ê°™ì€ aggregate rootì— ëŒ€í•œ ì´ë²¤íŠ¸ëŠ” ê°™ì€ íŒŒí‹°ì…˜ì—ì„œ ì²˜ë¦¬ë˜ì–´ì•¼ ìˆœì„œê°€ ë³´ì¥ë©ë‹ˆë‹¤.

**ì„¤ì • ë‚´ìš©:**
- `like-events`, `product-events`: `productId`ë¥¼ íŒŒí‹°ì…˜ í‚¤ë¡œ ì‚¬ìš©í•˜ì—¬, ê°™ì€ ìƒí’ˆì— ëŒ€í•œ ì´ë²¤íŠ¸ëŠ” í•­ìƒ ê°™ì€ íŒŒí‹°ì…˜ì—ì„œ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
- `order-events`: `orderId`ë¥¼ íŒŒí‹°ì…˜ í‚¤ë¡œ ì‚¬ìš©í•˜ì—¬, ê°™ì€ ì£¼ë¬¸ì— ëŒ€í•œ ì´ë²¤íŠ¸ëŠ” í•­ìƒ ê°™ì€ íŒŒí‹°ì…˜ì—ì„œ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.

**ê´€ë ¨ ì½”ë“œ:**
```java
// OutboxBridgeEventListener.java - íŒŒí‹°ì…˜ í‚¤ ì„¤ì •
outboxEventService.saveEvent(..., partitionKey: productId.toString());  // like-events, product-events
outboxEventService.saveEvent(..., partitionKey: orderId.toString());     // order-events

// OutboxEventPublisher.java - Kafka ë©”ì‹œì§€ì— íŒŒí‹°ì…˜ í‚¤ ì„¤ì •
messageBuilder.setHeader(KafkaHeaders.KEY, event.getPartitionKey());
```

**ê³ ë¯¼í•œ ì :**
- íŒŒí‹°ì…˜ í‚¤ë¥¼ `productId` ë˜ëŠ” `orderId`ë¡œ ì„¤ì •í–ˆëŠ”ë°, ì´ë¡œ ì¸í•œ íŒŒí‹°ì…˜ ë¶ˆê· í˜• ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, íŠ¹ì • ìƒí’ˆì— ëŒ€í•œ ì´ë²¤íŠ¸ê°€ ë§¤ìš° ë§ìœ¼ë©´ í•´ë‹¹ ìƒí’ˆì˜ íŒŒí‹°ì…˜ì—ë§Œ ë©”ì‹œì§€ê°€ ì§‘ì¤‘ë˜ì–´ ë‹¤ë¥¸ íŒŒí‹°ì…˜ì€ ë¹„ì–´ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ í˜„ì¬ êµ¬í˜„ì—ì„œëŠ” íŒŒí‹°ì…˜ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆœì„œë¥¼ ë³´ì¥í•˜ëŠ” ê²ƒì´ ë” ì¤‘ìš”í•˜ë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤. ë§Œì•½ íŒŒí‹°ì…˜ ë¶ˆê· í˜•ì´ ì‹¬ê°í•œ ë¬¸ì œê°€ ëœë‹¤ë©´, íŒŒí‹°ì…˜ í‚¤ë¥¼ í•´ì‹œ í•¨ìˆ˜ë¡œ ë³€í™˜í•˜ê±°ë‚˜, ë³µí•© í‚¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ë“±ì˜ ë°©ì•ˆì„ ê³ ë ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- íŒŒí‹°ì…˜ í‚¤ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ëœë¤ í‚¤ë¥¼ ì‚¬ìš©í•˜ë©´ ì–´ë–¤ ë¬¸ì œê°€ ë°œìƒí• ê¹Œìš”? ì˜ˆë¥¼ ë“¤ì–´, ê°™ì€ ìƒí’ˆì— ëŒ€í•œ `LikeAdded`ì™€ `LikeRemoved` ì´ë²¤íŠ¸ê°€ ì„œë¡œ ë‹¤ë¥¸ íŒŒí‹°ì…˜ì— ë°œí–‰ë˜ë©´, Consumerê°€ `LikeRemoved`ë¥¼ ë¨¼ì € ì²˜ë¦¬í•˜ê³  `LikeAdded`ë¥¼ ë‚˜ì¤‘ì— ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš° ì¢‹ì•„ìš” ìˆ˜ê°€ ìŒìˆ˜ê°€ ë˜ê±°ë‚˜ ì˜ëª»ëœ ë©”íŠ¸ë¦­ì´ ìƒì„±ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ íŒŒí‹°ì…˜ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°™ì€ aggregate rootì— ëŒ€í•œ ì´ë²¤íŠ¸ëŠ” í•­ìƒ ê°™ì€ íŒŒí‹°ì…˜ì—ì„œ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ë˜ë„ë¡ í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.


## âœ… Checklist
- [x] **ë„ë©”ì¸(ì• í”Œë¦¬ì¼€ì´ì…˜) ì´ë²¤íŠ¸ ì„¤ê³„**
  - `apps/commerce-api/src/main/java/com/loopers/domain/like/LikeEvent.java`
  - `apps/commerce-api/src/main/java/com/loopers/domain/order/OrderEvent.java`
  - `apps/commerce-api/src/main/java/com/loopers/domain/product/ProductEvent.java`
  - ì´ë²¤íŠ¸ íƒ€ì…: `LikeAdded`, `LikeRemoved`, `OrderCreated`, `ProductViewed`

- [x] **Producer ì•±ì—ì„œ ë„ë©”ì¸ ì´ë²¤íŠ¸ ë°œí–‰**
  - `apps/commerce-api/src/main/java/com/loopers/application/outbox/OutboxBridgeEventListener.java`
  - `apps/commerce-api/src/main/java/com/loopers/infrastructure/outbox/OutboxEventPublisher.java`
  - í† í”½: `like-events`, `order-events`, `product-events`

- [x] **PartitionKey ê¸°ë°˜ì˜ ì´ë²¤íŠ¸ ìˆœì„œ ë³´ì¥**
  - `apps/commerce-api/src/main/java/com/loopers/domain/outbox/OutboxEvent.java` (partitionKey í•„ë“œ)
  - `apps/commerce-api/src/main/java/com/loopers/infrastructure/outbox/OutboxEventPublisher.java` (KafkaHeaders.KEY ì„¤ì •)
  - íŒŒí‹°ì…˜ í‚¤: `like-events`, `product-events` â†’ `productId`, `order-events` â†’ `orderId`

- [x] **At Least Once ë³´ì¥ (acks=all, idempotence=true)**
  - `modules/kafka/src/main/resources/kafka.yml` (19-21ì¤„)
  - ì„¤ì •: `acks: all`, `enable.idempotence: true`, `max.in.flight.requests.per.connection: 5`

- [x] **Transactional Outbox Pattern êµ¬í˜„**
  - `apps/commerce-api/src/main/java/com/loopers/domain/outbox/OutboxEvent.java`
  - `apps/commerce-api/src/main/java/com/loopers/application/outbox/OutboxEventService.java`
  - `apps/commerce-api/src/main/java/com/loopers/infrastructure/outbox/OutboxEventPublisher.java`
  - `apps/commerce-api/src/main/java/com/loopers/application/outbox/OutboxBridgeEventListener.java`

- [x] **ë©”ì‹œì§€ ë°œí–‰ ì‹¤íŒ¨ ì²˜ë¦¬**
  - `apps/commerce-api/src/main/java/com/loopers/infrastructure/outbox/OutboxEventPublisher.java` (63-69ì¤„)
  - ê°œë³„ ì´ë²¤íŠ¸ ë°œí–‰ ì‹¤íŒ¨ ì‹œ `FAILED` ìƒíƒœë¡œ ë³€ê²½í•˜ê³  ë‹¤ìŒ ìŠ¤ì¼€ì¤„ì—ì„œ ì¬ì‹œë„

### âš¾ Consumer (7/7)

- [x] **Consumerê°€ Metrics ì§‘ê³„ ì²˜ë¦¬**
  - `apps/commerce-streamer/src/main/java/com/loopers/interfaces/consumer/ProductMetricsConsumer.java`
  - `apps/commerce-streamer/src/main/java/com/loopers/application/metrics/ProductMetricsService.java`
  - ì§‘ê³„ ëŒ€ìƒ: ì¢‹ì•„ìš” ìˆ˜, íŒë§¤ëŸ‰, ì¡°íšŒ ìˆ˜

- [x] **Manual Ack ì²˜ë¦¬**
  - `modules/kafka/src/main/resources/kafka.yml` (27, 29ì¤„)
  - `apps/commerce-streamer/src/main/java/com/loopers/interfaces/consumer/ProductMetricsConsumer.java` (141, 217ì¤„)
  - ì„¤ì •: `enable-auto-commit: false`, `ack-mode: manual`

- [x] **`event_handled` í…Œì´ë¸” ê¸°ë°˜ ë©±ë“± ì²˜ë¦¬**
  - `apps/commerce-streamer/src/main/java/com/loopers/domain/eventhandled/EventHandled.java`
  - `apps/commerce-streamer/src/main/java/com/loopers/application/eventhandled/EventHandledService.java`
  - `apps/commerce-streamer/src/main/java/com/loopers/interfaces/consumer/ProductMetricsConsumer.java` (91, 275ì¤„)
  - UNIQUE ì œì•½ì¡°ê±´ìœ¼ë¡œ ë™ì‹œì„± ìƒí™©ì—ì„œë„ ì¤‘ë³µ ë°©ì§€

- [x] **`version` ê¸°ì¤€ ìµœì‹  ì´ë²¤íŠ¸ë§Œ ë°˜ì˜**
  - `apps/commerce-api/src/main/java/com/loopers/domain/outbox/OutboxEvent.java` (56ì¤„, version í•„ë“œ)
  - `apps/commerce-api/src/main/java/com/loopers/application/outbox/OutboxEventService.java` (59-60ì¤„, ë²„ì „ ìƒì„±)
  - `apps/commerce-api/src/main/java/com/loopers/infrastructure/outbox/OutboxEventPublisher.java` (99-102ì¤„, í—¤ë”ì— ì¶”ê°€)
  - `apps/commerce-streamer/src/main/java/com/loopers/interfaces/consumer/ProductMetricsConsumer.java` (100, 284ì¤„, í—¤ë”ì—ì„œ ì¶”ì¶œ)
  - `apps/commerce-streamer/src/main/java/com/loopers/application/metrics/ProductMetricsService.java` (100, 126ì¤„, ë²„ì „ ë¹„êµ)
  - `apps/commerce-streamer/src/main/java/com/loopers/domain/metrics/ProductMetrics.java` (shouldUpdate ë©”ì„œë“œ)

- [x] **`product_metrics` í…Œì´ë¸”ì— upsert**
  - `apps/commerce-streamer/src/main/java/com/loopers/domain/metrics/ProductMetrics.java`
  - `apps/commerce-streamer/src/main/java/com/loopers/application/metrics/ProductMetricsService.java`
  - `apps/commerce-streamer/src/main/java/com/loopers/infrastructure/metrics/ProductMetricsRepositoryImpl.java`

- [x] **ì¤‘ë³µ ë©”ì‹œì§€ ì¬ì „ì†¡ í…ŒìŠ¤íŠ¸**
  - `apps/commerce-streamer/src/test/java/com/loopers/interfaces/consumer/ProductMetricsConsumerTest.java` (352ì¤„, `handlesDuplicateMessagesIdempotently()`)
  - ë™ì¼í•œ `eventId`ë¥¼ ê°€ì§„ ë©”ì‹œì§€ê°€ í•œ ë²ˆë§Œ ì²˜ë¦¬ë˜ëŠ”ì§€ ê²€ì¦

- [x] **ì¬ê³  ì†Œì§„ ì‹œ ìƒí’ˆ ìºì‹œ ê°±ì‹ **
  - `apps/commerce-api/src/main/java/com/loopers/application/product/ProductEventHandler.java` (147-151ì¤„)
  - `apps/commerce-api/src/main/java/com/loopers/application/product/ProductCacheService.java` (evictProductDetailCache ë©”ì„œë“œ)
  - ì¬ê³  ì°¨ê° í›„ `stock == 0` ì²´í¬í•˜ì—¬ ìºì‹œ ë¬´íš¨í™”

## ğŸ“ References
- Source: https://github.com/Loopers-dev-lab/loopers-spring-java-template/pull/191
